<template>
  <div class="element-toolbar">
    <Tabs
      :tabs="tabs"
      v-model:value="activeTab"
      :tabsStyle="{ marginBottom: '8px' }"
      :tabStyle="{
        width: '30%',
        margin: '0 10%',
      }"
    />

    <div class="content">
      <div class="style" v-if="activeTab === 'style'">
        <ButtonGroup class="row">
          <CheckboxButton style="flex: 1" :checked="richTextAttrs.bold" @click="emitRichTextCommand('bold')"
            ><IconTextBold
          /></CheckboxButton>
          <CheckboxButton style="flex: 1" :checked="richTextAttrs.em" @click="emitRichTextCommand('em')"
            ><IconTextItalic
          /></CheckboxButton>
          <CheckboxButton
            style="flex: 1"
            :checked="richTextAttrs.underline"
            @click="emitRichTextCommand('underline')"
            ><IconTextUnderline
          /></CheckboxButton>
          <CheckboxButton
            style="flex: 1"
            :checked="richTextAttrs.strikethrough"
            @click="emitRichTextCommand('strikethrough')"
            ><IconStrikethrough
          /></CheckboxButton>
        </ButtonGroup>

        <ButtonGroup class="row">
          <Button style="flex: 1" @click="emitRichTextCommand('fontsize-add')"><IconFontSize />+</Button>
          <Button style="flex: 1" @click="emitRichTextCommand('fontsize-reduce')"><IconFontSize />-</Button>
        </ButtonGroup>

        <Divider :margin="20" />

        <RadioGroup
          class="row"
          button-style="solid"
          :value="richTextAttrs.align"
          @update:value="(value) => emitRichTextCommand('align', value)"
        >
          <RadioButton value="left" style="flex: 1"><IconAlignTextLeft /></RadioButton>
          <RadioButton value="center" style="flex: 1"><IconAlignTextCenter /></RadioButton>
          <RadioButton value="right" style="flex: 1"><IconAlignTextRight /></RadioButton>
        </RadioGroup>

        <Divider :margin="20" />

        <div class="row-block">
          <div class="label">{{ $t('mobile.toolbar.element.textColor') }}</div>
          <div class="colors">
            <div class="color" v-for="color in colors" :key="color" @click="updateFontColor(color)">
              <div class="color-block" :style="{ backgroundColor: color }"></div>
            </div>
          </div>
        </div>
        <div class="row-block">
          <div class="label">{{ $t('mobile.toolbar.element.fillColor') }}</div>
          <div class="colors">
            <div class="color" v-for="color in colors" :key="color" @click="updateFill(color)">
              <div class="color-block" :style="{ backgroundColor: color }"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="common" v-if="activeTab === 'common'">
        <ButtonGroup class="row">
          <Button style="flex: 1" @click="copyElement()"
            ><IconCopy class="icon" /> {{ $t('mobile.toolbar.element.copy') }}</Button
          >
          <Button style="flex: 1" @click="deleteElement()"
            ><IconDelete class="icon" /> {{ $t('mobile.toolbar.element.delete') }}</Button
          >
        </ButtonGroup>

        <Divider :margin="20" />

        <ButtonGroup class="row">
          <Button style="flex: 1" @click="orderElement(handleElement!, ElementOrderCommands.TOP)"
            ><IconSendToBack class="icon" /> {{ $t('mobile.toolbar.element.bringToFront') }}</Button
          >
          <Button style="flex: 1" @click="orderElement(handleElement!, ElementOrderCommands.BOTTOM)"
            ><IconBringToFrontOne class="icon" /> {{ $t('mobile.toolbar.element.sendToBack') }}</Button
          >
          <Button style="flex: 1" @click="orderElement(handleElement!, ElementOrderCommands.UP)"
            ><IconBringToFront class="icon" /> {{ $t('mobile.toolbar.element.moveForward') }}</Button
          >
          <Button style="flex: 1" @click="orderElement(handleElement!, ElementOrderCommands.DOWN)"
            ><IconSentToBack class="icon" /> {{ $t('mobile.toolbar.element.moveBackward') }}</Button
          >
        </ButtonGroup>

        <Divider :margin="20" />

        <ButtonGroup class="row">
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.LEFT)"
            ><IconAlignLeft class="icon" /> {{ $t('mobile.toolbar.element.alignLeft') }}</Button
          >
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.HORIZONTAL)"
            ><IconAlignVertically class="icon" />
            {{ $t('mobile.toolbar.element.centerHorizontally') }}</Button
          >
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.RIGHT)"
            ><IconAlignRight class="icon" /> {{ $t('mobile.toolbar.element.alignRight') }}</Button
          >
        </ButtonGroup>
        <ButtonGroup class="row">
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.TOP)"
            ><IconAlignTop class="icon" /> {{ $t('mobile.toolbar.element.alignTop') }}</Button
          >
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.VERTICAL)"
            ><IconAlignHorizontally class="icon" />
            {{ $t('mobile.toolbar.element.centerVertically') }}</Button
          >
          <Button style="flex: 1" @click="alignElementToCanvas(ElementAlignCommands.BOTTOM)"
            ><IconAlignBottom class="icon" /> {{ $t('mobile.toolbar.element.alignBottom') }}</Button
          >
        </ButtonGroup>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref } from 'vue';
import { useI18n } from 'vue-i18n';
const { t } = useI18n();
import { storeToRefs } from 'pinia';
import { useMainStore, useSlidesStore } from '@/store';
import type { PPTElement, TableCell } from '@/types/slides';
import { ElementAlignCommands, ElementOrderCommands } from '@/types/edit';
import emitter, { EmitterEvents } from '@/utils/emitter';
import useOrderElement from '@/hooks/useOrderElement';
import useAlignElementToCanvas from '@/hooks/useAlignElementToCanvas';
import useDeleteElement from '@/hooks/useDeleteElement';
import useAddSlidesOrElements from '@/hooks/useAddSlidesOrElements';
import useHistorySnapshot from '@/hooks/useHistorySnapshot';

import CheckboxButton from '@/components/CheckboxButton.vue';
import Tabs from '@/components/Tabs.vue';
import Divider from '@/components/Divider.vue';
import Button from '@/components/Button.vue';
import ButtonGroup from '@/components/ButtonGroup.vue';
import RadioButton from '@/components/RadioButton.vue';
import RadioGroup from '@/components/RadioGroup.vue';

interface TabItem {
  key: 'style' | 'common';
  label: string;
}

const colors = [
  '$foreground',
  '$background',
  '#eeece1',
  '#1e497b',
  '#4e81bb',
  '#e2534d',
  '#9aba60',
  '#8165a0',
  '#47acc5',
  '#f9974c',
  '#c21401',
  '#ff1e02',
  '#ffc12a',
  '#ffff3a',
  '#90cf5b',
  '#00af57',
];

const mainStore = useMainStore();
const slidesStore = useSlidesStore();
const { handleElement, handleElementId, richTextAttrs } = storeToRefs(mainStore);

const { addHistorySnapshot } = useHistorySnapshot();

const updateElement = (id: string, props: Partial<PPTElement>) => {
  slidesStore.updateElement({ id, props });
  addHistorySnapshot();
};

const tabs: TabItem[] = [
  { key: 'style', label: t('mobile.toolbar.element.style') },
  { key: 'common', label: t('mobile.toolbar.element.layout') },
];
const activeTab = ref('common');

const { orderElement } = useOrderElement();
const { alignElementToCanvas } = useAlignElementToCanvas();
const { addElementsFromData } = useAddSlidesOrElements();
const { deleteElement } = useDeleteElement();

const copyElement = () => {
  const element: PPTElement = JSON.parse(JSON.stringify(handleElement.value));
  addElementsFromData([element]);
};

const emitRichTextCommand = (command: string, value?: string) => {
  emitter.emit(EmitterEvents.RICH_TEXT_COMMAND, { action: { command, value } });
};

const updateFontColor = (color: string) => {
  if (!handleElement.value) return;
  if (
    handleElement.value.type === 'text' ||
    (handleElement.value.type === 'shape' && handleElement.value.text?.content)
  ) {
    emitter.emit(EmitterEvents.RICH_TEXT_COMMAND, { action: { command: 'color', value: color } });
  }
  if (handleElement.value.type === 'table') {
    const data: TableCell[][] = JSON.parse(JSON.stringify(handleElement.value.data));
    for (let i = 0; i < data.length; i++) {
      for (let j = 0; j < data[i].length; j++) {
        const style = data[i][j].style || {};
        data[i][j].style = { ...style, color };
      }
    }
    updateElement(handleElementId.value, { data });
  }
  if (handleElement.value.type === 'latex') {
    updateElement(handleElementId.value, { color });
  }
};

const updateFill = (color: string) => {
  if (!handleElement.value) return;
  if (
    handleElement.value.type === 'text' ||
    handleElement.value.type === 'shape' ||
    handleElement.value.type === 'chart'
  )
    updateElement(handleElementId.value, { fill: color });

  if (handleElement.value.type === 'table') {
    const data: TableCell[][] = JSON.parse(JSON.stringify(handleElement.value.data));
    for (let i = 0; i < data.length; i++) {
      for (let j = 0; j < data[i].length; j++) {
        const style = data[i][j].style || {};
        data[i][j].style = { ...style, backcolor: color };
      }
    }
    updateElement(handleElementId.value, { data });
  }

  if (handleElement.value.type === 'audio') updateElement(handleElementId.value, { color });
};
</script>

<style lang="scss" scoped>
.element-toolbar {
  width: 100%;
  height: 240px;
  position: absolute;
  z-index: 99;
  bottom: 0;
  left: 0;
  background-color: $background;
  box-shadow: 0 0 15px 0 $shadow-light;
  display: flex;
  flex-direction: column;
  animation: slideInUp 0.15s;
}

@keyframes slideInUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

.content {
  padding: 10px;
  flex: 1;
  overflow: auto;
}
.row {
  width: 100%;
  display: flex;
  align-items: center;
  margin-bottom: 10px;

  .icon {
    margin-right: 3px;
  }
}
.row-block {
  margin-bottom: 10px;
  background-color: $lightGray;
  border-radius: $borderRadius;
  padding: 10px;
}
.label {
  font-size: 13px;
  margin-bottom: 20px;
  margin-left: 6px;
}
.colors {
  @include flex-grid-layout();
}
.color {
  @include flex-grid-layout-children(8, 12%);

  padding-bottom: 5px;
  display: flex;
  justify-content: center;
  align-items: center;

  .color-block {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }
}
</style>
