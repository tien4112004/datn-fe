# Data Model: Manage Class Roster

**Feature**: 004-manage-class-roster  
**Date**: October 30, 2025  
**Purpose**: Define entities, relationships, validation schemas, and state management for roster CRUD operations

## Overview

This document defines the data structures and validation rules for managing class rosters. The feature extends the existing `Student` entity with form-specific validation schemas and state transitions for add, edit, and delete operations.

## Entities

### Student (Existing Entity)

**Source**: `container/src/features/classes/types/entities/student.ts`

**Description**: Represents an individual enrolled in a class. This entity already exists and matches all requirements from the feature specification (FR-001 through FR-014).

**Schema**:
```typescript
export interface Student {
  id: string;                    // UUID generated by backend
  studentCode: string;           // Unique student identifier (FR-004)
  firstName: string;             // Required (FR-001, FR-002)
  lastName: string;              // Required (FR-001, FR-002)
  fullName: string;              // Computed: firstName + lastName
  dateOfBirth: string;           // ISO 8601 date format (optional)
  gender: StudentGender;         // 'male' | 'female' | 'other' (optional)
  email?: string;                // Required for roster management (FR-001, FR-003)
  phone?: string;                // Optional contact info
  address?: string;              // Optional contact info
  parentName?: string;           // Optional guardian info
  parentPhone?: string;          // Optional guardian contact
  classId: string;               // Foreign key to Class entity
  enrollmentDate: string;        // ISO 8601 date format
  status: StudentStatus;         // 'active' | 'transferred' | 'graduated' | 'dropped'
  createdAt: string;             // Timestamp (ISO 8601)
  updatedAt: string;             // Timestamp (ISO 8601)
}

export type StudentStatus = 'active' | 'transferred' | 'graduated' | 'dropped';
export type StudentGender = 'male' | 'female' | 'other';
```

**Notes**:
- No changes needed to existing Student entity
- `email` field currently optional (`email?:`) but spec requires it (FR-001) - validation will enforce this at form level
- `fullName` is computed field (concatenation of firstName + lastName)

---

### StudentFormData (New Type)

**Purpose**: Type-safe form data for add/edit operations with validation

**Schema** (Zod):
```typescript
import { z } from 'zod';

/**
 * Email validation regex (RFC 5322 simplified)
 * Validates basic email structure: user@domain.tld
 */
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

/**
 * Student form validation schema
 * Used by React Hook Form with zodResolver
 */
export const studentFormSchema = z.object({
  // Required fields (FR-002)
  firstName: z
    .string({ required_error: 'roster.validation.firstNameRequired' })
    .min(1, 'roster.validation.firstNameRequired')
    .max(100, 'roster.validation.firstNameTooLong'),

  lastName: z
    .string({ required_error: 'roster.validation.lastNameRequired' })
    .min(1, 'roster.validation.lastNameRequired')
    .max(100, 'roster.validation.lastNameTooLong'),

  studentCode: z
    .string({ required_error: 'roster.validation.studentCodeRequired' })
    .min(1, 'roster.validation.studentCodeRequired')
    .max(50, 'roster.validation.studentCodeTooLong')
    .trim(),
    // Note: Uniqueness validation (FR-004) handled separately via refine() with async check

  email: z
    .string({ required_error: 'roster.validation.emailRequired' })
    .min(1, 'roster.validation.emailRequired')
    .regex(emailRegex, 'roster.validation.emailInvalid')  // FR-003
    .max(255, 'roster.validation.emailTooLong'),

  // Optional fields
  phone: z
    .string()
    .max(20, 'roster.validation.phoneTooLong')
    .optional()
    .or(z.literal('')), // Allow empty string (form input default)

  address: z
    .string()
    .max(500, 'roster.validation.addressTooLong')
    .optional()
    .or(z.literal('')),

  parentName: z
    .string()
    .max(100, 'roster.validation.parentNameTooLong')
    .optional()
    .or(z.literal('')),

  parentPhone: z
    .string()
    .max(20, 'roster.validation.parentPhoneTooLong')
    .optional()
    .or(z.literal('')),

  dateOfBirth: z
    .string()
    .optional()
    .or(z.literal(''))
    .refine(
      (val) => !val || !isNaN(Date.parse(val)),
      'roster.validation.dateOfBirthInvalid'
    ),

  gender: z
    .enum(['male', 'female', 'other'], {
      errorMap: () => ({ message: 'roster.validation.genderInvalid' }),
    })
    .optional(),
});

/**
 * Inferred TypeScript type from Zod schema
 * Ensures compile-time type safety matches runtime validation
 */
export type StudentFormData = z.infer<typeof studentFormSchema>;
```

**Validation Rules**:
- **Required fields**: firstName, lastName, studentCode, email (FR-002)
- **Email format**: Regex validation for basic structure (FR-003)
- **String lengths**: Max lengths prevent database overflow and UI breaking
- **Empty strings**: Treated as undefined for optional fields (HTML input behavior)
- **Date format**: Validates ISO 8601 format if provided
- **Gender enum**: Restricted to 'male' | 'female' | 'other'

**Uniqueness Validation** (FR-004):
```typescript
/**
 * Extended schema with async duplicate check
 * Applied in form component with access to classId and existing students
 */
export const createStudentFormSchema = (classId: string, existingStudents: Student[], currentStudentId?: string) => {
  return studentFormSchema.extend({
    studentCode: studentFormSchema.shape.studentCode.refine(
      async (code) => {
        // Skip check if editing current student with same code
        if (currentStudentId) {
          const currentStudent = existingStudents.find(s => s.id === currentStudentId);
          if (currentStudent?.studentCode === code) return true;
        }

        // Check against local cache (immediate feedback)
        const isDuplicate = existingStudents.some(
          s => s.studentCode === code && s.id !== currentStudentId
        );
        return !isDuplicate;
      },
      'roster.validation.duplicateStudentCode'
    ),
  });
};
```

---

### StudentCreateRequest (Existing Type)

**Source**: `container/src/features/classes/types/requests/studentRequests.ts`

**Purpose**: API request payload for creating new student

**Schema**:
```typescript
export interface StudentCreateRequest {
  studentCode: string;
  firstName: string;
  lastName: string;
  dateOfBirth: string;
  gender: 'male' | 'female' | 'other';
  email?: string;
  phone?: string;
  address?: string;
  parentName?: string;
  parentPhone?: string;
  classId: string;
  enrollmentDate?: string;  // Defaults to current date if omitted
}
```

**Transformation** from `StudentFormData`:
```typescript
const toCreateRequest = (formData: StudentFormData, classId: string): StudentCreateRequest => ({
  ...formData,
  classId,
  email: formData.email,  // Now required in form
  enrollmentDate: new Date().toISOString(),  // Auto-set to now
  dateOfBirth: formData.dateOfBirth || new Date().toISOString(),  // Default if not provided
  gender: formData.gender || 'other',  // Default if not provided
});
```

---

### StudentUpdateRequest (Existing Type)

**Source**: `container/src/features/classes/types/requests/studentRequests.ts`

**Purpose**: API request payload for updating existing student

**Schema**:
```typescript
export interface StudentUpdateRequest extends Partial<StudentCreateRequest> {
  id: string;
  status?: 'active' | 'transferred' | 'graduated' | 'dropped';
}
```

**Transformation** from `StudentFormData`:
```typescript
const toUpdateRequest = (formData: StudentFormData, studentId: string): StudentUpdateRequest => ({
  id: studentId,
  ...formData,
  email: formData.email,  // Now required in form
  // Status not editable in roster form (separate feature)
});
```

---

## Relationships

```
┌─────────────────┐
│     Class       │
│                 │
│  id: string     │
│  name: string   │
│  ...            │
└────────┬────────┘
         │
         │ 1:N (has many)
         │
         ▼
┌─────────────────┐
│    Student      │
│                 │
│  id: string     │──┐
│  classId: FK    │  │
│  studentCode    │  │ Unique constraint
│  firstName      │  │ within classId
│  lastName       │  │
│  email          │  │
│  ...            │  │
└─────────────────┘  │
                     │
         ┌───────────┘
         │
         ▼
┌─────────────────┐
│ Unique Index    │
│ (classId,       │
│  studentCode)   │
└─────────────────┘
```

**Constraints**:
- **One-to-Many**: Each Class has many Students
- **Uniqueness**: studentCode must be unique within a Class (enforced by backend)
- **Referential Integrity**: Student.classId references Class.id (foreign key)

---

## State Management

### React Query Cache Structure

```typescript
// Query keys
const queryKeys = {
  students: (classId: string) => ['students', classId] as const,
  studentDetail: (studentId: string) => ['students', 'detail', studentId] as const,
};

// Cache data structure
type StudentsCache = {
  queryKey: ['students', string];  // ['students', classId]
  data: Student[];                 // Array of students in this class
};
```

### Form State (React Hook Form)

```typescript
interface UseStudentFormState {
  // Form data (managed by React Hook Form)
  formData: StudentFormData;
  
  // Form state flags
  isDirty: boolean;        // Has user modified any field?
  isValid: boolean;        // Do all fields pass validation?
  isSubmitting: boolean;   // Is mutation in progress?
  
  // Field-level errors
  errors: FieldErrors<StudentFormData>;
  
  // Methods
  handleSubmit: () => void;
  reset: () => void;
  setValue: (field: keyof StudentFormData, value: any) => void;
}
```

### Mutation State (React Query)

```typescript
interface StudentMutationState {
  // Create mutation
  createStudent: {
    mutate: (data: StudentCreateRequest) => void;
    isLoading: boolean;
    isError: boolean;
    error: Error | null;
  };
  
  // Update mutation
  updateStudent: {
    mutate: (data: StudentUpdateRequest) => void;
    isLoading: boolean;
    isError: boolean;
    error: Error | null;
  };
  
  // Delete mutation
  deleteStudent: {
    mutate: (studentId: string) => void;
    isLoading: boolean;
    isError: boolean;
    error: Error | null;
  };
}
```

---

## State Transitions

### Add Student Flow

```
┌──────────────┐
│ Initial Form │  Empty form, all fields blank
│  (Create)    │
└──────┬───────┘
       │
       │ User fills required fields
       ▼
┌──────────────┐
│ Form Valid   │  All validations pass (FR-002, FR-003)
│              │
└──────┬───────┘
       │
       │ User clicks "Add Student"
       ▼
┌──────────────┐
│ Submitting   │  isSubmitting = true, button disabled
│              │
└──────┬───────┘
       │
       │ Mutation executes
       ▼
    ┌──┴──┐
    │ API │
    └──┬──┘
       │
  ┌────┴────┐
  │         │
  ▼         ▼
Success   Error
  │         │
  │         │ Rollback optimistic update
  │         │ Show error message (FR-013)
  │         │ Keep form open with data
  │         │
  │         └──► User can retry
  │
  │ Optimistic update (immediate UI change)
  │ Toast success message (FR-009)
  │ Invalidate cache (refetch for consistency)
  │ Reset form
  │ Close dialog
  │
  ▼
┌──────────────┐
│ Roster       │  New student visible in table
│  Updated     │
└──────────────┘
```

### Edit Student Flow

```
┌──────────────┐
│ Initial Form │  Pre-filled with existing data (FR-006)
│   (Edit)     │
└──────┬───────┘
       │
       │ User modifies fields
       ▼
┌──────────────┐
│ Form Dirty   │  isDirty = true (unsaved changes)
│              │
└──────┬───────┘
       │
       │ Validation runs (including duplicate check if studentCode changed)
       ▼
┌──────────────┐
│ Form Valid   │  All validations pass
│              │
└──────┬───────┘
       │
       │ User clicks "Save"
       ▼
┌──────────────┐
│ Submitting   │  isSubmitting = true, button disabled
│              │
└──────┬───────┘
       │
       │ Mutation executes
       ▼
    ┌──┴──┐
    │ API │
    └──┬──┘
       │
  ┌────┴────┐
  │         │
  ▼         ▼
Success   Error
  │         │
  │         │ Rollback optimistic update
  │         │ Show error message (FR-013)
  │         │ Keep dialog open for retry
  │         │
  ▼         ▼
┌──────────────┐
│ Roster       │  Student data updated in table
│  Updated     │  Toast success message (FR-009)
│              │  Invalidate cache
│              │  Close dialog
└──────────────┘
```

### Delete Student Flow

```
┌──────────────┐
│ Roster View  │  User clicks "Delete" button on student row
│              │
└──────┬───────┘
       │
       │ Click "Delete"
       ▼
┌──────────────┐
│ Confirmation │  AlertDialog opens (FR-008)
│   Dialog     │  Shows: "Remove {studentName}?"
│              │  Buttons: "Cancel" | "Confirm"
└──────┬───────┘
       │
  ┌────┴────┐
  │         │
  ▼         ▼
Cancel   Confirm
  │         │
  │ Close   │ Mutation executes
  │ dialog  │ isSubmitting = true
  │         │
  │         ▼
  │      ┌──┴──┐
  │      │ API │
  │      └──┬──┘
  │         │
  │    ┌────┴────┐
  │    │         │
  │    ▼         ▼
  │  Success   Error
  │    │         │
  │    │         │ Rollback optimistic update
  │    │         │ Show error toast (FR-013)
  │    │         │ Close confirmation dialog
  │    │         │
  │    │         └──► Student remains in roster
  │    │
  │    │ Optimistic update (remove from cache immediately)
  │    │ Toast success message (FR-009)
  │    │ Invalidate cache
  │    │ Close dialog
  │    │
  │    ▼
  │ ┌──────────────┐
  └─► Roster       │  Student removed from table
    │  Updated     │
    └──────────────┘
```

---

## Validation Rules Summary

| Field | Required | Min Length | Max Length | Format | Async Check |
|-------|----------|------------|------------|--------|-------------|
| firstName | ✅ Yes | 1 | 100 | - | - |
| lastName | ✅ Yes | 1 | 100 | - | - |
| studentCode | ✅ Yes | 1 | 50 | Trimmed | ✅ Unique in class |
| email | ✅ Yes | 1 | 255 | Email regex | - |
| phone | ❌ No | - | 20 | - | - |
| address | ❌ No | - | 500 | - | - |
| parentName | ❌ No | - | 100 | - | - |
| parentPhone | ❌ No | - | 20 | - | - |
| dateOfBirth | ❌ No | - | - | ISO 8601 | - |
| gender | ❌ No | - | - | enum | - |

**Validation Timing**:
- **On Blur**: Individual field validation runs (instant feedback)
- **On Submit**: Full form validation runs (including async checks)
- **On Change** (for studentCode): Debounced duplicate check (500ms delay)

---

## Error Handling

### Client-Side Errors (Zod)

```typescript
// Field-level errors
{
  firstName: { message: "First name is required", type: "required" },
  email: { message: "Please enter a valid email address", type: "regex" },
  studentCode: { message: "This student ID already exists", type: "refine" }
}
```

**Display**: Show error message below field (inline validation)

### Server-Side Errors (API)

```typescript
// HTTP status codes
{
  400: "Bad Request - Validation failed",
  403: "Forbidden - Permission denied", 
  404: "Not Found - Student not found",
  409: "Conflict - Duplicate student ID",
  500: "Internal Server Error - Unknown error"
}
```

**Display**: Show toast notification with specific error message

### Network Errors

```typescript
{
  error: "Network Error",
  message: "Unable to connect to server. Please check your internet connection."
}
```

**Display**: Show toast notification, preserve form state for retry

---

## Indexing Strategy (Backend)

Recommended database indexes for optimal query performance:

```sql
-- Primary key
CREATE UNIQUE INDEX idx_students_id ON students(id);

-- Foreign key for joins
CREATE INDEX idx_students_class_id ON students(class_id);

-- Unique constraint for studentCode within class (FR-004)
CREATE UNIQUE INDEX idx_students_class_code ON students(class_id, student_code);

-- Search optimization (for roster filtering)
CREATE INDEX idx_students_name ON students(last_name, first_name);

-- Status filtering
CREATE INDEX idx_students_status ON students(status);
```

---

## Performance Considerations

### Client-Side
- **Form rendering**: < 100ms (lightweight Radix components, minimal re-renders)
- **Validation**: Synchronous validation instant, async checks < 500ms
- **Optimistic updates**: Immediate UI change (0ms perceived latency)
- **Cache invalidation**: Background refetch doesn't block UI

### Server-Side (Assumptions)
- **GET /students**: < 200ms for ~50 students
- **POST /students**: < 300ms (includes uniqueness check)
- **PUT /students/{id}**: < 300ms
- **DELETE /students/{id}**: < 200ms

---

**Status**: ✅ Data model complete - All entities, validations, and state transitions defined
