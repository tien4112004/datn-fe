openapi: 3.0.3
info:
  title: CSV Student Import API
  description: API endpoints for bulk importing students from CSV files
  version: 1.0.0
  contact:
    name: Development Team

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: https://api.example.com/api
    description: Production server

paths:
  /classes/{classId}/students/import:
    post:
      summary: Import students from CSV file
      description: |
        Bulk import student accounts from a CSV file. The backend validates data,
        generates student IDs, checks for duplicates, and creates all students in
        a single transaction.
        
        Frontend sends the raw CSV file. Backend handles all parsing and validation.
      operationId: importStudents
      tags:
        - Students
        - Import
      parameters:
        - name: classId
          in: path
          required: true
          description: Unique identifier of the class to import students into
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file containing student data
            encoding:
              file:
                contentType: text/csv, application/csv
      responses:
        '201':
          description: Students successfully imported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportSuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    studentsCreated: 25
                    message: "Successfully imported 25 students"
        '400':
          description: Validation errors in CSV data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportErrorResponse'
              examples:
                validation_errors:
                  value:
                    success: false
                    message: "Validation errors found in CSV file"
                    errors:
                      - row: 2
                        field: "email"
                        message: "Email format is invalid"
                        code: "INVALID_EMAIL_FORMAT"
                      - row: 5
                        field: "email"
                        message: "Email already exists in the system"
                        code: "DUPLICATE_EMAIL"
                      - row: 7
                        field: "firstName"
                        message: "First name is required"
                        code: "REQUIRED_FIELD_MISSING"
                missing_columns:
                  value:
                    success: false
                    message: "Required columns missing from CSV"
                    errors:
                      - row: 0
                        field: null
                        message: "Required column 'Email' not found in CSV headers"
                        code: "MISSING_REQUIRED_COLUMN"
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - user does not have permission to import students
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Class not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: File too large (exceeds server limit)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "File size exceeds maximum limit of 10MB"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An unexpected error occurred while processing the import"
      security:
        - bearerAuth: []

  /classes/{classId}/students/import/template:
    get:
      summary: Download CSV template
      description: |
        Returns a CSV template file with correct column headers and example data.
        Teachers can download this, fill it with student information, and import it.
      operationId: downloadTemplate
      tags:
        - Students
        - Import
      parameters:
        - name: classId
          in: path
          required: true
          description: Class identifier (for future use, currently template is generic)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: CSV template file
          content:
            text/csv:
              schema:
                type: string
                example: |
                  First Name,Last Name,Email,Date of Birth,Phone Number,Parent/Guardian Name,Parent/Guardian Email,Additional Notes
                  John,Doe,john.doe@example.com,2010-05-15,555-0100,Jane Doe,jane.doe@example.com,Honor student
                  Alice,Smith,alice.smith@example.com,2009-11-22,,,alice.parent@example.com,
          headers:
            Content-Disposition:
              description: Attachment filename
              schema:
                type: string
                example: 'attachment; filename="student_import_template.csv"'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

components:
  schemas:
    ImportSuccessResponse:
      type: object
      required:
        - success
        - studentsCreated
        - message
      properties:
        success:
          type: boolean
          example: true
          description: Indicates successful import
        studentsCreated:
          type: integer
          minimum: 0
          example: 25
          description: Number of student accounts created
        message:
          type: string
          example: "Successfully imported 25 students"
          description: Human-readable success message

    ImportErrorResponse:
      type: object
      required:
        - success
        - message
        - errors
      properties:
        success:
          type: boolean
          example: false
          description: Indicates import failed
        message:
          type: string
          example: "Validation errors found in CSV file"
          description: Summary error message
        errors:
          type: array
          description: Detailed validation errors
          items:
            $ref: '#/components/schemas/ValidationError'

    ValidationError:
      type: object
      required:
        - row
        - message
        - code
      properties:
        row:
          type: integer
          minimum: 0
          example: 2
          description: |
            1-indexed row number where error occurred.
            Row 0 indicates a file-level error (e.g., missing columns).
        field:
          type: string
          nullable: true
          example: "email"
          description: |
            Field name where error occurred. Null for row-level or file-level errors.
        message:
          type: string
          example: "Email format is invalid"
          description: Human-readable error message
        code:
          type: string
          example: "INVALID_EMAIL_FORMAT"
          description: Machine-readable error code for client-side handling
          enum:
            - MISSING_REQUIRED_COLUMN
            - REQUIRED_FIELD_MISSING
            - INVALID_EMAIL_FORMAT
            - DUPLICATE_EMAIL
            - DUPLICATE_EMAIL_IN_FILE
            - INVALID_DATE_FORMAT
            - INVALID_PHONE_FORMAT
            - MALFORMED_CSV
            - EMPTY_FILE
            - NO_DATA_ROWS

    ErrorResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "An error occurred"
        details:
          type: string
          description: Additional error details (optional, for debugging)

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from authentication endpoint.
        Include in Authorization header as: `Bearer <token>`

tags:
  - name: Students
    description: Student management operations
  - name: Import
    description: Bulk import operations
